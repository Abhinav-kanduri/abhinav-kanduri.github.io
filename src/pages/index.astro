---
import Layout     from '../layouts/Layout.astro';
import BlogCard   from '../components/BlogCard.astro';
import Newsletter from '../components/Newsletter.astro';
import TagList    from '../components/TagList.astro';

// 1. Glob all markdown posts from each category
const tutorials     = import.meta.glob('./tutorials/*.md',    { eager: true });
const architectures = import.meta.glob('./architecture/*.md', { eager: true });
const tools         = import.meta.glob('./tools/*.md',        { eager: true });
const cases         = import.meta.glob('./case-studies/*.md', { eager: true });

// 2. Merge into one list with a category tag
function flatten(mods, category) {
  return Object.entries(mods).map(([path, mod]) => {
    const slug = path.replace(/^\.\/[^/]+\/(.*)\.md$/, '$1');
    const {
      title,
      description,
      pubDate,
      heroImage,
      tags,
      author
    } = mod.frontmatter;
    return {
      slug,
      title,
      description,
      publishDate: new Date(pubDate),
      heroImage,
      tags,
      author,       // { name: string, image: string }
      category
    };
  });
}

const allPosts = [
  ...flatten(tutorials,     'tutorials'),
  ...flatten(architectures, 'architecture'),
  ...flatten(tools,         'tools'),
  ...flatten(cases,         'case-studies'),
];

// 3. Sort by publishDate descending
allPosts.sort((a, b) => b.publishDate - a.publishDate);

// 4. Pick out Featured (first 2) and Recent (next 4)
const featuredPosts = allPosts.slice(0, 2);
const recentPosts   = allPosts.slice(2, 6);
---

<Layout title="Home">
  <!-- Hero Section -->
  <section class="bg-gradient-to-br from-primary-900 to-primary-800 text-white py-20">
    <div class="max-w-4xl mx-auto text-center px-4">
      <h1 class="text-5xl font-bold mb-4">Bridging Generative AI & Data Engineering</h1>
      <p class="text-xl mb-8">Code‑first tutorials and deep‑dive case studies at the intersection of AI and infrastructure.</p>
      <div class="flex flex-wrap justify-center gap-4">
        <a href="/tutorials" class="btn btn-primary px-6 py-3">Browse Tutorials</a>
        <a href="/subscribe" class="btn btn-outline px-6 py-3">Subscribe</a>
      </div>
    </div>
  </section>

  <!-- Featured Insights -->
  <section class="py-16 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4">
      <h2 class="text-3xl font-bold mb-8">Featured Insights</h2>
      <div class="grid md:grid-cols-2 gap-8">
        {featuredPosts.map(post => (
          <a
            href={`/${post.category}/${post.slug}`}
            class="block border rounded-lg overflow-hidden hover:shadow-lg transition-shadow"
          >
            <img src={post.heroImage} alt={post.title} class="w-full h-48 object-cover" />
            <div class="p-6">
              <h3 class="text-2xl font-semibold mb-2">{post.title}</h3>
              <p class="text-gray-700 mb-4">{post.description}</p>
              <div class="flex items-center">
                <img
                  src={post.author.image}
                  alt={post.author.name}
                  class="h-8 w-8 rounded-full mr-2"
                />
                <span class="text-sm text-gray-600">{post.author.name}</span>
              </div>
            </div>
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- Latest Articles -->
  <section class="py-16">
    <div class="max-w-7xl mx-auto px-4">
      <h2 class="text-3xl font-bold mb-8">Latest Articles</h2>
      <div class="grid lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-2 grid md:grid-cols-2 gap-8">
          {recentPosts.map(post => (
            <a
              href={`/${post.category}/${post.slug}`}
              class="block border rounded-lg overflow-hidden hover:shadow-md transition-shadow"
            >
              <img src={post.heroImage} alt={post.title} class="w-full h-40 object-cover" />
              <div class="p-4">
                <h3 class="text-xl font-semibold mb-1">{post.title}</h3>
                <p class="text-gray-600 mb-3">{post.description}</p>
                <div class="flex items-center">
                  <img
                    src={post.author.image}
                    alt={post.author.name}
                    class="h-6 w-6 rounded-full mr-2"
                  />
                  <span class="text-sm text-gray-500">{post.author.name}</span>
                </div>
              </div>
            </a>
          ))}
        </div>

        <!-- Sidebar -->
        <div class="space-y-8">
          <div class="bg-white rounded-lg p-6 shadow-sm">
            <h3 class="text-xl font-semibold mb-4">Popular Topics</h3>
            <TagList tags={allPosts.flatMap(p => p.tags)} showAll={false} />
          </div>
          <Newsletter />
          <div class="bg-white rounded-lg p-6 shadow-sm">
            <h3 class="text-xl font-semibold mb-4">Resources</h3>
            <ul class="space-y-3">
              <li><a href="/getting-started" class="hover:underline">Getting Started Guide</a></li>
              <li><a href="/code-examples" class="hover:underline">Code Examples</a></li>
              <li><a href="/tools" class="hover:underline">Tools & Libraries</a></li>
              <li><a href="/case-studies" class="hover:underline">Case Studies</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>
